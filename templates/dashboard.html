<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Lofi Streamer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        // Simple script to toggle between URL and File Upload inputs
        function toggleInput(type) {
            document.getElementById('url-input-group').style.display = (type === 'url') ? 'block' : 'none';
            document.getElementById('file-input-group').style.display = (type === 'upload') ? 'block' : 'none';
            document.getElementById('video_url').required = (type === 'url');
            document.getElementById('video_file').required = (type === 'upload');
        }
    </script>
</head>
<body onload="toggleInput('url')">
    <div class="container">
        <header>
            <h1>Lofi Streamer Dashboard</h1>
            <a href="{{ url_for('logout') }}" class="btn">Logout</a>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card system-stats">
            <h2>System Status</h2>
            <p><strong>CPU Usage:</strong> {{ '%.2f'|format(cpu) }}%</p>
            <p><strong>RAM Usage:</strong> {{ '%.2f'|format(ram) }}%</p>
            {% if gpu %}
            <div class="gpu-stats">
                <p><strong>GPU Usage:</strong> {{ gpu.gpu_util }}</p>
                <p><strong>VRAM Usage:</strong> {{ gpu.mem_util }} ({{ gpu.mem_used }} / {{ gpu.mem_total }})</p>
            </div>
            {% else %}
            <p><strong>GPU:</strong> Not Detected</p>
            {% endif %}
        </div>

        <div class="card">
            <h2>Add New Stream</h2>
            <form action="{{ url_for('add_stream') }}" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="stream_name">Stream Name</label>
                    <input type="text" id="stream_name" name="stream_name" placeholder="My Lofi Stream" required>
                </div>
                <div class="form-group">
                    <label>Input Source</label>
                    <div class="radio-group">
                        <label><input type="radio" name="input_type" value="url" checked onchange="toggleInput('url')"> Video URL</label>
                        <label><input type="radio" name="input_type" value="upload" onchange="toggleInput('upload')"> Upload File</label>
                    </div>
                </div>
                <div id="url-input-group" class="form-group">
                    <label for="video_url">Video/Stream URL</label>
                    <input type="url" id="video_url" name="video_url" placeholder="https://example.com/video.mp4">
                </div>
                <div id="file-input-group" class="form-group" style="display: none;">
                    <label for="video_file">MP4 Video File</label>
                    <input type="file" id="video_file" name="video_file" accept="video/mp4">
                </div>
                 <div class="form-group">
                    <label for="rtmp_urls">RTMP URL(s) (one per line)</label>
                    <textarea id="rtmp_urls" name="rtmp_urls" rows="3" placeholder="rtmp://a.rtmp.youtube.com/live2/your-key
rtmps://live-api-s.facebook.com:443/rtmp/your-key" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Stream</button>
            </form>
        </div>

        <h2>Configured Streams ({{ streams|length }})</h2>
        <div class="streams-grid">
            {% for id, stream in streams.items() %}
            <div class="card stream-card">
                <h3>
                    {{ stream.name }} 
                    <span class="status-dot {{ stream.status|lower }}">{{ stream.status }}</span>
                </h3>
                <p><strong>Input:</strong> <span class="input-path">{{ stream.input }}</span></p>
                <p><strong>Destinations:</strong> {{ stream.rtmp_urls|length }}</p>
                {% if stream.status == 'Running' and stream.pid %}
                <p><strong>PID:</strong> {{ stream.pid }}</p>
                {% endif %}
                <div class="actions">
                    {% if stream.status == 'Stopped' %}
                    <form action="{{ url_for('handle_start', stream_id=id) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-success">Start</button>
                    </form>
                    {% else %}
                    <form action="{{ url_for('handle_stop', stream_id=id) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-warning">Stop</button>
                    </form>
                    {% endif %}
                    <form action="{{ url_for('handle_delete', stream_id=id) }}" method="post" style="display:inline;">
                         <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this stream?');">Delete</button>
                    </form>
                </div>
            </div>
            {% else %}
            <p>No streams configured yet. Add one above to get started!</p>
            {% endfor %}
        </div>
    </div>
</body>
</html>
